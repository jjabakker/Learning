---
title: "Cheat Sheet"
author: "Hans"
date: "9/11/2019"
output: html_document
---


Important references:

http://www.cookbook-r.com

https://www.r-graph-gallery.com



# Setup - always run

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(pacman)
p_load(tidyverse)
p_load(nycflights13)
p_load(ggplot2)
p_load(Deriv)
p_load(deSolve)
p_load(phaseR)
p_load(gridExtra)
theme_set(theme_minimal())
```


# Plot a graph of a function

```{r }

myfun <- function(x, a) {
  1 / (1 + exp(-x + 10) / a)
}

xseq = seq(0, 10, 0.01)
yseq = myfun(xseq, 2)
df = data.frame(xseq, yseq)

ggplot(df) +
  geom_line(mapping = aes(x = xseq, y = yseq), color = "blue") +
  ylim(0, 1) +
  labs(title = "Plot Title", 
       x = "Horizontal label", 
       y = "Vertical label")
```



# Get derivative and plot

```{r}


f1 <- function(x, a, b, c, h) {
  a*x^2 + b*exp(x) + c - h
}

xmin = -10
xmax = 3
xstep = 0.01

a_val = 2
b_val = 3
c_val = 5
h_val = 0

# Define vector of x values and corresponding function values for plotting
xvals = seq(xmin, xmax, xstep) 
yvals = f1(xvals, a_val, b_val, c_val, h_val)

df.f1 = Deriv(f1, "x")
df.f1
dyvals = df.f1(xvals, a_val, b_val, c_val, h_val)

df = data.frame(xvals, yvals, dyvals)

# Plot the function
ggplot(df) +
  geom_line(mapping = aes(x = xvals, y = yvals), color = "blue") +
  labs(title = "Plot Title", 
       x = "Horizontal label", 
       y = "Vertical label")


# Plot the derivative
ggplot(df) +
  geom_line(mapping = aes(x = xvals, y = dyvals), color = "blue") +
  labs(title = "Plot Title", 
       x = "Horizontal label", 
       y = "Vertical label")

# Or plot them in one graph
ggplot(df) +
  geom_line(mapping = aes(x = xvals, y = yvals), color = "blue") +
  geom_line(mapping = aes(x = xvals, y = dyvals), color = "red") +
  labs(title = "Plot Title", 
       x = "Horizontal label", 
       y = "Vertical label")

```
# Numerically integrate

```{r }

myfun <- function(x, a) {
  1 / (1 + exp(-x + 10) / a)
}

xseq = seq(0, 10, 0.01)
yseq = myfun(xseq, 2)
df = data.frame(xseq, yseq)

ggplot(df) +
  geom_line(mapping = aes(x = xseq, y = yseq), color = "blue") +
  labs(title = "Plot Title", 
       x = "Horizontal label", 
       y = "Vertical label")

integrate(myfun, 0, 1, a = 2)
```


# Solve equation

```{r}

f1 <- function(x) {
  2*x^2 - 5
}

xseq = seq(0, 3, 0.01)
yseq = f1(xseq)
df = data.frame(xseq, yseq)

ggplot(df) +
  geom_line(mapping = aes(x = xseq, y = yseq), color = "blue") +
  labs(title = "Plot Title", 
       x = "Horizontal label", 
       y = "Vertical label")

xcross = uniroot(f1, lower = 1, upper = 2)
xcross$root
(f1(xcross$root))

```


# Solve simple ODE 

```{r}

ode_func = function(timepoint, state, parameters) { 
  with (as.list(c(state, parameters)), {
    dY = a * Y  # Function definition
    list(c(dY)) 
  })
}

pars = c(a = 0.2)
inistate = c(Y = 1)
time_series = seq(0, 10, by = 0.1)

out = ode(y = inistate, 
          times = time_series, 
          func = ode_func, 
          parms = pars)

df = data.frame(out)
ggplot(data = df) +
  geom_line(mapping = aes(x=time, y = Y))

```


# Phase portrait and stability

```{r}

# In this function the paremeter is Y
# This needs to be entered in state.names

ode_func = function(timepoint, state, parameters) { 
  with (as.list(c(state, parameters)), {
    dY = a * Y  # Function definition
    list(c(dY)) 
  })
}

pars <- c(a = -0.2)

phaseport = phasePortrait(ode_func, 
                          parameters = pars, 
                          ylim = c(-2, 2), 
                          points = 10, 
                          xlab = "Y", 
                          ylab = "dY/dt (a = 1)", 
                          state.names = c("Y")     
                          ) 
grid() 

stab.expgrowth = stability(ode_func, 
                           ystar = 0, 
                           parameters = pars, 
                           system = "one.dim", 
                           state.names = c("Y")    # Do not forget this
                           )

```

# Simple ggplot recipes

Refer to:https://www.r-graph-gallery.com

## Scatterplot

```{r}
?mpg
glimpse(mpg)

# Create a simple dot plot. 

p <- ggplot(data = mpg)
p <- p + geom_point(mapping = aes(x = displ, y = hwy, color = cyl), 
                    alpha = 0.3,
                    size = 1,
                    shape = 25)  # Values from 0..25
p <- p + labs(color = "Cylinder cont.")
p <- p + labs(x = "New x label")
p <- p + labs(y = "New y label")
p <- p + labs(title = "New Plot", subtitle = "New subtitle")
p <- p + labs(caption = "(based on data from ...)")
p

```

## Line plot

```{r}

# Example 1

xValue <- 1:100
yValue <- cumsum(rnorm(100))
dataf   <- data.frame(xValue, yValue)

p <- ggplot(data = dataf)
p <- p + geom_line(mapping = aes(x = xValue, y = yValue), 
                   alpha = 0.3,
                   size = 1)
p <- p + labs(color = "Cylinder cont.")
p <- p + labs(x = "New x label")
p <- p + labs(y = "New y label")
p <- p + labs(title = "New Plot", subtitle = "New subtitle")
p <- p + labs(caption = "(based on data from ...)")
p

# Example 2

x <- seq(-4,4,0.1)
y <- dnorm(x)
ggplot() + geom_line(aes(x = x, y = y))

```


## Bar plot 

```{r}
# Example 1
data <- data.frame(
  name = c("A","B","C","D","E") ,  
  value = c(3,12,5,18,45)
  )

ggplot(data, aes(x=name, y=value)) + 
  geom_bar(stat = "identity")

# Example 2
x <- 0:50
y <- dbinom(x, size=50, prob=.33)
ggplot() + geom_bar(aes(x=x, y=y), stat = "identity", width = 0.2)

```

## Histogram

```{r}
data=data.frame(value=rnorm(100))

ggplot(data) + 
  geom_histogram(aes(x=value), bins = 50)

```


## Smooth line

```{r}

ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) + 
  geom_point() +
  geom_smooth()

```


## Controlling ggplot elements
 
 
### Color a series 

```{r}

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy),  color = "red")
```


### Set line type

Some choices are:

* blank
* dashed
* dotted
* dotdash
* longdash
* twodash

```{r}

x <- seq(-4,4,0.1)
y <- dnorm(x)

ggplot() + 
  geom_line(aes(x = x, y = y), linetype = 'dashed')

ggplot() + 
  geom_line(aes(x = x, y = y), linetype = 'dotted')

```


### Set labels 

```{r}
p <- ggplot(data = mpg) +
    geom_point(mapping = aes(x = displ, y = hwy)) 

p <- p + labs(color = "Cylinder cont.")
p <- p + labs(x = "New x label")
p <- p + labs(y = "New y label")
p <- p + labs(title = "New Plot", subtitle = "New subtitle")
p <- p + labs(caption = "(based on data from ...)")
p
```


### Set tick marks

```{r}

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy)) + 
  scale_y_continuous(breaks=seq(0, 60, 5)) +
  scale_x_continuous(breaks=seq(0, 10, .5)) 
```


### Display elements of data seperately

```{r}

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, color = class))

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, alpha = class))

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, size = class))

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, shape = class))
```


### Split the graph in 'facets'
  
```{r}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy)) +
  facet_wrap(~ class, nrow = 2)

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy)) +
  facet_grid(drv ~ cyl)

# This is a different format
ggplot(data = mpg, mapping = aes (x = hwy, y = cyl)) +
  geom_point()
```


### Variations
```{r}

# Now for the variations 
ggplot(data = mpg)  +
  geom_point(mapping = aes (x = displ, y = hwy))

ggplot(data = mpg)  +
  geom_smooth(mapping = aes (x = displ, y = hwy))

# You can combine the two above graphs easily....

ggplot(data = mpg)  +
  geom_point(mapping = aes (x = displ, y = hwy)) +
  geom_smooth(mapping = aes (x = displ, y = hwy))

# Same effect as before, but with parameters more conveniently reorganised
ggplot(data = mpg, mapping = aes (x = displ, y = hwy))  +
  geom_point() +
  geom_smooth()

# You can select data also

ggplot(data = mpg, mapping = aes (x = displ, y = hwy))  +
  geom_point(mapping = aes(color = class)) +
  geom_smooth(
    data = filter(mpg, class == "subcompact"))

ggplot(data = mpg, mapping = aes (x = displ, y = hwy))  +
  geom_point(mapping = aes(color = class)) +
  geom_smooth(
    data = filter(mpg, class == "subcompact"),
    se = FALSE)

ggplot(data = mpg, mapping = aes (x = displ, y = hwy))  +
  geom_point(mapping = aes(color = class)) +
  geom_smooth(
    data = filter(mpg, class == "pickup"))

ggplot(data = mpg)  +
  geom_smooth(mapping = aes (x = displ, y = hwy,  class = drv)) +
    geom_hline(yintercept = 20, col = 'green')

```


### Set limits

```{r}
x <- seq(-4, 4, 0.1)
y <- dnorm(x)
p <- ggplot() + geom_line(aes(x = x, y = y))

p <-p + ylim(-0.1, 0.7) 
p <-p + xlim(-2, 2)
p
```



### Horizontal and vertical line

```{r}

n = 10
ggplot(data.frame(x = 1:n, y = 1:n), 
       aes(x = x, y = y)) +
  geom_hline(yintercept = 2, col = 'red') + 
  geom_hline(yintercept = 4, col = 'green') +
  geom_vline(xintercept = 2) + 
  geom_line(size = 1)
```


### Plot in a grid

```{r}

# Needs library gridExtra

p <- ggplot(data = mpg)
p1 <- p + geom_point(mapping = aes(x = displ, y = hwy, color = cyl)) 
p2 <- p + geom_point(mapping = aes(x = displ, y = cyl, color = hwy))

gridExtra::grid.arrange(
    ggplot(mtcars, aes(wt, mpg)) + geom_point(), 
    ggplot(iris, aes(Sepal.Length, Petal.Length)) + geom_point(), 
    nrow = 1)
    
gridExtra::grid.arrange(
    p1,
    p2,
    nrow = 1)
```


# Remove NA values

```{r}
# Create a tibble with NA values in it

dd = tibble(x = 1:10,
            y = x^2,
            z = y - 60)
dd[2,2] = NA
dd[2,3] = NA
dd[7,2] = NA
dd[8,2] = NA
dd[6,3] = NA
dd

# Remove all records where a NA occurs
dd[complete.cases(dd), ]

# Remove all records where a NA occurs in column x
dd[complete.cases(dd['x']), ]

# Remove all records where a NA occurs in column y
dd[complete.cases(dd['y']), ]

# Can do the same with
dd
drop_na(dd,c(y))
drop_na(dd,c(z))
drop_na(dd,c(y,z))
drop_na(dd)
```
# Wrangling

## Gather and spread

```{r}
ChickWeight
cw <- ChickWeight %>% as_tibble

cw_w <-  cw %>% spread(key = Time, value = weight)
cw_w

cw_l <- cw_w %>% gather(key = "Time", value = "Weight", c(`0`:`21`))
cw_l


# You can arrange the output

cw_l %>%
  arrange(as.numeric(Time), desc(Diet))

# But for some reason you can not arrange on Chick
```


## Detect outlier

```{r}

library(dslabs)

# The data set contains a big outlier
data(outlier_example)
outlier_example

# You can see that because mean and median differ a lot
mean(outlier_example)
median(outlier_example)

# You can see that also because sd is large
sd(outlier_example)

# You can see that also in the histogram
qplot(outlier_example)

# You can see that also in the boxplot
boxplot(outlier_example)

# See if there are values > 8. See! There is one 180 
outlier_example[outlier_example > 8]

# At what index des it sit?
which(outlier_example > 8)

# Remove it form the dataset
oe <- outlier_example[-which(outlier_example>8)]
mean(oe)
median(oe)
sd(oe)
qplot(oe)
boxplot(oe)

```


## Select - columns

```{r}
iris

# For the selection purpose just consider the first few records 
short_iris <- head(iris, 20)

select(short_iris, starts_with("Petal"))
select(short_iris, Species, everything())   #reorder
select(short_iris, -Sepal.Length)
```



## Filter - rows

```{r}
starwars
class(starwars)

# It works on a dataframe

filter(starwars, species == 'Human')
filter(starwars, mass > 100)
filter(starwars, species == 'Human', mass > 100)
filter(starwars, species == 'Human' & mass > 100)
filter(starwars, species == 'Human' | mass > 100)

# It works just as well on a tibble

tib_starwars = as.tibble(starwars)
class(tib_starwars)
filter(tib_starwars, species == 'Human')
```


## Mutate 
```{r}
library(modelr)
data(heights)
library(measurements)
heights

h <- heights %>%
  mutate(
    weight_kg_man = weight * 0.453592,
    weight_kg_pkg = conv_unit(weight, "lbs", "kg"),
    height_m = conv_unit(height, "inch", "m")
  ) %>%
  select(starts_with('weight'), starts_with("height"))
h
```

```{r}
my_heights <- heights %>%
  mutate(
    weight = conv_unit(weight, "lbs", "kg"),
    height = conv_unit(height, "inch", "m"),
    bmi = weight / height  ^ 2
  ) %>% select(bmi, education)
my_heights
```

```{r}
h <- my_heights %>%
  arrange(bmi) %>%
  select(bmi, education)
h
```


## Create data for testing

```{r}

tribble(
  ~colA, ~colB, ~colC,
  "a",   1,     0.1,
  "b",   2,     0.2,
  "c",   3,     0.3
)

tibble(colA = c("a","b","c"),
       colB = c(1,2,3),
       colc = c(0.1, 0.2, 0.3))
```


# Analyse

## Inspect data

```{r}
head(mpg)
glimpse(mpg)
names(mpg)

# How many values exist? 
count(mpg, model)
count(mpg, trans)

mpg %>% 
  group_by(model) %>%
  summarise(n = n())

```


## Summarise / Group

```{r}
# Summarise two variables
summarise(mpg, 
          mean_hwy = mean(hwy),
          mean_cyl = mean(cyl, na.rm = TRUE))

# Summarise a variable grouped by another variable
s <- group_by(mpg,class)
summarise(s, mean_hwy = mean(hwy))

# Summarise a variable grouped by another variable, using pipes
mpg %>%
  group_by(class) %>%
  summarise(mean_hwy = mean(hwy))

# Summarise a variable grouped by two variable, using pipes
mpg %>%
  group_by(class, trans) %>%
  summarise(mean_hwy = mean(hwy),
            mean_cyl = mean(cyl, na.rm = TRUE))
```

